<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Naveed Textiles Billing</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial, sans-serif;background:#f2f2f2;margin:0;padding:10px}
#pdfWrapper{
  width: 100%;
  max-width: 794px;
  margin: auto;
  background: white;
  padding: 15px;
  box-sizing: border-box;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

/* HIGHLIGHTED TITLE STYLE */
.header{text-align:center; padding-bottom: 10px;}
.header img{max-width:110px; border-radius: 50%; margin-bottom: 10px;}
.header h1 {
    background: #2196F3; 
    color: white; 
    padding: 10px; 
    border-radius: 5px; 
    margin: 0; 
    letter-spacing: 2px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
}

.box{border:1px solid #000;padding:10px;margin-top:10px}

/* Mobile Responsive Flex */
.flex{display:flex;gap:10px;flex-wrap:wrap; flex-direction: column;}
@media (min-width: 600px) { .flex { flex-direction: row; } }
.flex > div{flex:1}

input{width:100%;padding:8px;box-sizing:border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;}

/* Scrollable table */
.table-container { width: 100%; overflow-x: auto; margin-top: 10px; }
table{width:100%;border-collapse:collapse; min-width: 500px;}
th,td{border:1px solid #000;padding:8px;text-align:center}

button{padding:12px;margin-top:10px;width:100%; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: 0.3s;}
.btn-add { background: #607d8b; color: white; }
.btn-download { background: #4CAF50; color: white; }
.btn-whatsapp { background: #25D366; color: white; }
.btn-new { background: #2196F3; color: white; }

canvas{border:1px solid #000; width:100%; height: 160px; touch-action:none; background: #fafafa; margin-top: 5px;}

/* HIGHLIGHTED CREDIT STYLE */
.credit-footer {
    text-align: center;
    margin-top: 20px;
    padding: 10px;
    background: #f9f9f9;
    border-top: 1px dashed #ccc;
    font-size: 14px;
    color: #333;
}
.credit-footer strong { color: #2196F3; }

.no-print { display: block; }
@media print {
  .no-print { display: none !important; }
  body { background: white; padding: 0; }
  #pdfWrapper { box-shadow: none; border: none; width: 100%; }
}
</style>
</head>

<body>

<div id="pdfWrapper">
    <div class="header">
      <img src="logo.png" alt="Naveed Textiles Logo">
      <h1>NAVEED TEXTILES</h1>
    </div>

    <div class="box">
      <strong>Email:</strong> naveedtextiles14@gmail.com<br>
      <strong>Phone:</strong> 9906403030 / 9906851124
    </div>

    <div class="box flex">
      <div>Customer Name<input id="custName" placeholder="Enter name"></div>
      <div>Phone<input id="custPhone" placeholder="Enter phone"></div>
      <div>Address<input id="custaddress" placeholder="Enter address"></div>
    </div>

    <div class="box flex">
      <div>Bill No<input id="invoiceNo" readonly></div>
      <div>Date<input id="billDate" type="date"></div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr style="background: #f0f0f0;">
                    <th style="width: 40px;">#</th>
                    <th>Item Description</th>
                    <th style="width: 80px;">Qty</th>
                    <th style="width: 100px;">Price</th>
                    <th style="width: 120px;">Amount</th>
                </tr>
            </thead>
            <tbody id="items">
                <tr>
                    <td>1</td>
                    <td><input placeholder="Item name"></td>
                    <td><input type="number" value="1" oninput="calc()"></td>
                    <td><input type="number" value="0" oninput="calc()"></td>
                    <td class="amt">0.00</td>
                </tr>
            </tbody>
        </table>
    </div>

    <button class="btn-add no-print" onclick="addRow()">+ Add Item Row</button>

    <div class="box flex">
      <div>Discount %<input id="disc" type="number" value="0" oninput="calc()"></div>
      <div>GST %<input id="gst" type="number" value="0" oninput="calc()"></div>
      <div>Paid ₹<input id="paid" type="number" value="0" oninput="calc()"></div>
    </div>

    <div class="box" style="background: #fdfdfd;">
        <h2 id="total" style="margin: 5px 0; color: #2c3e50;">Total: ₹0.00</h2>
        <h3 id="balance" style="margin: 5px 0; color: #d32f2f;">Balance Due: ₹0.00</h3>
    </div>

    <div class="box">
      <h3 style="margin-top: 0;">Authorized Signature</h3>
      <canvas id="sign"></canvas>
      <button class="no-print" style="background:#f1f1f1; color:#333; font-size: 12px; padding: 5px; width: auto; margin-top: 5px;" onclick="clearSign()">Clear Signature</button>
    </div>

    <div class="credit-footer">
        Web built by <strong>Mautasim</strong>
    </div>
</div>

<div style="max-width: 794px; margin: 15px auto; display: flex; gap: 10px; flex-wrap: wrap;" class="no-print">
    <button class="btn-download" style="flex: 1;" onclick="downloadPDF()">Download PDF</button>
    <button class="btn-whatsapp" style="flex: 1;" onclick="whatsappPDF()">Share via WhatsApp</button>
    <button class="btn-new" style="flex: 1;" onclick="resetForm()">New Invoice</button>
</div>

<div id="historySection" class="no-print" style="max-width: 794px; margin: 20px auto; background: white; padding: 15px; border: 1px solid #ccc; border-radius: 8px;">
    <h3 style="margin-top:0; border-bottom: 2px solid #2196F3; padding-bottom: 5px;">Invoice History</h3>
    <input type="text" id="searchInput" onkeyup="filterHistory()" placeholder="Search by name or bill number..." style="margin-bottom: 15px;">
    
    <div style="overflow-x: auto;">
        <table id="historyTable" style="min-width: 100%;">
            <thead>
                <tr style="background: #eee;">
                    <th>Bill No</th><th>Date</th><th>Customer</th><th>Total</th><th>Actions</th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>
</div>

<script>
let inv = parseInt(localStorage.getItem('inv')) || 1000;

function init() {
    document.getElementById('invoiceNo').value = 'INV-' + (inv + 1);
    document.getElementById('billDate').value = new Date().toISOString().split('T')[0];
    loadHistory();
    initCanvas();
}

function addRow(name='', qty='1', price='0') {
    const t = document.getElementById('items');
    const r = t.insertRow();
    r.innerHTML = `
        <td>${t.rows.length}</td>
        <td><input value="${name}"></td>
        <td><input type="number" value="${qty}" oninput="calc()"></td>
        <td><input type="number" value="${price}" oninput="calc()"></td>
        <td class="amt">0.00</td>`;
    calc();
}

function calc() {
    let sum = 0;
    document.querySelectorAll('#items tr').forEach(r => {
        let q = parseFloat(r.cells[2].querySelector('input').value) || 0;
        let p = parseFloat(r.cells[3].querySelector('input').value) || 0;
        let a = q * p;
        r.querySelector('.amt').innerText = a.toFixed(2);
        sum += a;
    });
    let d = sum * (parseFloat(document.getElementById('disc').value) || 0) / 100;
    let g = (sum - d) * (parseFloat(document.getElementById('gst').value) || 0) / 100;
    let total = sum - d + g;
    document.getElementById('total').innerText = `Total: ₹${total.toFixed(2)}`;
    document.getElementById('balance').innerText = 'Balance Due: ₹' + (total - (parseFloat(document.getElementById('paid').value) || 0)).toFixed(2);
}

function saveBill() {
    const billId = document.getElementById('invoiceNo').value;
    const items = [];
    document.querySelectorAll('#items tr').forEach(r => {
        let n = r.cells[1].querySelector('input').value;
        if(n) items.push({name: n, qty: r.cells[2].querySelector('input').value, price: r.cells[3].querySelector('input').value});
    });

    const billData = {
        id: billId, date: document.getElementById('billDate').value,
        name: document.getElementById('custName').value, phone: document.getElementById('custPhone').value,
        address: document.getElementById('custaddress').value, items: items,
        disc: document.getElementById('disc').value, gst: document.getElementById('gst').value,
        paid: document.getElementById('paid').value, total: document.getElementById('total').innerText
    };

    let history = JSON.parse(localStorage.getItem('billHistory') || '[]');
    const idx = history.findIndex(b => b.id === billId);
    if (idx > -1) { history[idx] = billData; } else { history.push(billData); inv++; localStorage.setItem('inv', inv); }
    localStorage.setItem('billHistory', JSON.stringify(history));
    loadHistory();
}

function loadHistory() {
    const history = JSON.parse(localStorage.getItem('billHistory') || '[]');
    const body = document.getElementById('historyBody');
    body.innerHTML = '';
    history.slice().reverse().forEach(bill => {
        const row = body.insertRow();
        row.innerHTML = `<td>${bill.id}</td><td>${bill.date}</td><td>${bill.name || 'N/A'}</td><td>${bill.total}</td>
            <td>
                <button onclick="editBill('${bill.id}')" style="background:orange; color:white; padding:5px; width:auto;">Edit</button>
                <button onclick="deleteBill('${bill.id}')" style="background:red; color:white; padding:5px; width:auto;">Del</button>
            </td>`;
    });
}

function editBill(id) {
    const history = JSON.parse(localStorage.getItem('billHistory') || '[]');
    const b = history.find(x => x.id === id);
    if (!b) return;
    document.getElementById('invoiceNo').value = b.id;
    document.getElementById('custName').value = b.name;
    document.getElementById('custPhone').value = b.phone;
    document.getElementById('custaddress').value = b.address;
    document.getElementById('disc').value = b.disc;
    document.getElementById('gst').value = b.gst;
    document.getElementById('paid').value = b.paid;
    document.getElementById('items').innerHTML = '';
    b.items.forEach(i => addRow(i.name, i.qty, i.price));
    calc();
    window.scrollTo(0,0);
}

function deleteBill(id) {
    if(confirm("Delete this invoice?")) {
        let history = JSON.parse(localStorage.getItem('billHistory') || '[]');
        localStorage.setItem('billHistory', JSON.stringify(history.filter(x => x.id !== id)));
        loadHistory();
    }
}

function filterHistory() {
    let input = document.getElementById("searchInput").value.toUpperCase();
    let tr = document.getElementById("historyBody").getElementsByTagName("tr");
    for (let i = 0; i < tr.length; i++) {
        tr[i].style.display = (tr[i].textContent || tr[i].innerText).toUpperCase().indexOf(input) > -1 ? "" : "none";
    }
}

function resetForm() {
    if(!confirm("Start a new bill?")) return;
    inv = parseInt(localStorage.getItem('inv')) || 1000;
    document.getElementById('invoiceNo').value = 'INV-' + (inv + 1);
    document.getElementById('custName').value = '';
    document.getElementById('custPhone').value = '';
    document.getElementById('custaddress').value = '';
    document.getElementById('items').innerHTML = '';
    addRow(); 
    document.getElementById('disc').value = 0;
    document.getElementById('gst').value = 0;
    document.getElementById('paid').value = 0;
    clearSign(); calc();
}

const canvas = document.getElementById('sign');
const ctx = canvas.getContext('2d');
let drawing = false;

function initCanvas() { 
    canvas.width = canvas.offsetWidth; 
    canvas.height = canvas.offsetHeight; 
    ctx.lineWidth = 2; 
    ctx.lineCap = 'round'; 
}

const getPos = (e) => {
    const r = canvas.getBoundingClientRect();
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: cx - r.left, y: cy - r.top };
};

canvas.addEventListener('mousedown', (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); });
canvas.addEventListener('mousemove', (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); });
window.addEventListener('mouseup', () => drawing = false);
canvas.addEventListener('touchstart', (e) => { e.preventDefault(); drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); }, {passive:false});
canvas.addEventListener('touchmove', (e) => { e.preventDefault(); if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); }, {passive:false});
function clearSign() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

async function makePDF() {
    const el = document.getElementById('pdfWrapper');
    const c = await html2canvas(el, {
        scale: 2,
        useCORS: true,
        scrollY: -window.scrollY, 
        windowWidth: 794,
        height: el.offsetHeight
    });
    const imgData = c.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (c.height * pdfWidth) / c.width;
    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
    return pdf;
}

async function downloadPDF() { saveBill(); const pdf = await makePDF(); pdf.save(document.getElementById('invoiceNo').value + '.pdf'); }
async function whatsappPDF() {
    saveBill(); const pdf = await makePDF();
    const blob = pdf.output('blob');
    const file = new File([blob], 'Invoice.pdf', { type: 'application/pdf' });
    if (navigator.share) { navigator.share({ files: [file], title: 'Invoice' }); } 
    else { alert("Please use Chrome or Safari for sharing."); }
}

window.onload = init;
window.onresize = initCanvas;
</script>
</body>
</html>
