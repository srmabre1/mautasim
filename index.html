<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Naveed Textiles - Official</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #eaeff2; margin: 0; padding: 10px; }
    
    /* Forces the capture area to be a specific size so it's never cut off */
    #pdfWrapper { 
        width: 600px; 
        margin: auto; 
        background: white; 
        padding: 25px; 
        border: 1px solid #ccc;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    @media (max-width: 620px) {
        body { padding: 0; }
        #pdfWrapper { transform: scale(0.6); transform-origin: top center; margin-bottom: -250px; }
        .controls { margin-top: 20px !important; }
    }

    .header { text-align: center; border-bottom: 2px solid #2196F3; padding-bottom: 10px; margin-bottom: 20px; }
    .header h1 { color: #2196F3; margin: 5px 0; letter-spacing: 2px; font-size: 28px; }
    
    .box { border: 1px solid #ddd; padding: 12px; margin-top: 10px; border-radius: 4px; }
    .flex { display: flex; gap: 10px; }
    .flex div { flex: 1; font-size: 13px; font-weight: bold; color: #444; }
    
    input { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 14px; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th { background: #2196F3; color: white; padding: 10px; font-size: 13px; }
    td { border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 14px; }
    
    #signCanvas { border: 1px solid #000; background: #fdfdfd; width: 100%; height: 140px; touch-action: none; margin-top: 10px; }
    
    .controls { display: flex; gap: 10px; max-width: 600px; margin: 30px auto; padding: 0 10px; }
    button { padding: 15px; flex: 1; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 15px; transition: 0.3s; }
    
    .btn-add { background: #546e7a; color: white; width: 100%; margin-top: 10px; }
    .btn-pdf { background: #2e7d32; color: white; }
    .btn-wa { background: #25D366; color: white; }
    .btn-new { background: #1565c0; color: white; }

    .history-section { max-width: 600px; margin: 20px auto; background: white; padding: 15px; border-radius: 5px; }
</style>
</head>
<body>

<div id="pdfWrapper">
    <div class="header">
        <div style="font-weight: bold; color: #2196F3; font-size: 40px;">NT</div>
        <h1>NAVEED TEXTILES</h1>
        <p style="margin: 0; font-size: 13px; color: #666;">naveedtextiles14@gmail.com | 9906403030</p>
    </div>

    <div class="box flex">
        <div>Customer Name<input id="cN" placeholder="Full Name"></div>
        <div>Phone<input id="cP" placeholder="0000000000"></div>
    </div>
    <div class="box">
        <div>Address<input id="cA" placeholder="Shop/Home Address"></div>
    </div>

    <div class="box flex">
        <div>Invoice No<input id="iN" readonly style="background:#f0f0f0; border:none;"></div>
        <div>Date<input id="bD" type="date"></div>
    </div>

    <table>
        <thead>
            <tr>
                <th width="50">#</th>
                <th>Item Description</th>
                <th width="60">Qty</th>
                <th width="90">Price</th>
                <th width="100">Total</th>
            </tr>
        </thead>
        <tbody id="items">
            <tr>
                <td>1</td>
                <td><input type="text" style="margin:0"></td>
                <td><input type="number" value="1" oninput="calc()" style="margin:0"></td>
                <td><input type="number" value="0" oninput="calc()" style="margin:0"></td>
                <td class="row-total" style="font-weight:bold">0.00</td>
            </tr>
        </tbody>
    </table>
    
    <button class="btn-add" onclick="addRow()">+ Add New Item Line</button>

    <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
        <div style="background: #2196F3; color: white; padding: 15px 30px; border-radius: 4px;">
            <span style="font-size: 14px;">Grand Total:</span>
            <div id="gTotal" style="font-size: 24px; font-weight: bold;">₹0.00</div>
        </div>
    </div>

    <div class="box" style="margin-top: 30px; border: none; border-top: 1px solid #ccc; padding-top: 20px;">
        <strong style="font-size: 13px;">Authorized Signature:</strong><br>
        <canvas id="signCanvas"></canvas>
        <button onclick="clearS()" style="background:none; color:#d32f2f; border:none; cursor:pointer; font-size:12px;">[ Clear Signature ]</button>
    </div>

    <div style="text-align: center; color: #bbb; font-size: 11px; margin-top: 30px;" onclick="m_secret()">
        Developed & Managed by Mautasim
    </div>
</div>

<div class="controls">
    <button class="btn-pdf" onclick="saveBill('download')">Download Bill</button>
    <button class="btn-wa" onclick="saveBill('share')">Send WhatsApp</button>
    <button class="btn-new" onclick="location.reload()">New Bill</button>
</div>

<div class="history-section">
    <strong style="display:block; border-bottom: 1px solid #eee; padding-bottom: 5px;">Recent Bills</strong>
    <div id="hBody" style="font-size: 13px; margin-top: 10px;"></div>
</div>

<script>
    let invNum = parseInt(localStorage.getItem('invNum')) || 1000;
    const canvas = document.getElementById('signCanvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    window.onload = () => {
        document.getElementById('iN').value = "NT-" + (invNum + 1);
        document.getElementById('bD').value = new Date().toISOString().split('T')[0];
        
        // Ensure signature size is exact
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        showHistory();
    };

    function getXY(e) {
        const r = canvas.getBoundingClientRect();
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        return [cx - r.left, cy - r.top];
    }
    function start(e) { drawing = true; ctx.beginPath(); ctx.moveTo(...getXY(e)); e.preventDefault(); }
    function move(e) { if(!drawing) return; ctx.lineTo(...getXY(e)); ctx.stroke(); e.preventDefault(); }
    function stop() { drawing = false; }

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', move);
    window.addEventListener('mouseup', stop);
    canvas.addEventListener('touchstart', start, {passive: false});
    canvas.addEventListener('touchmove', move, {passive: false});
    canvas.addEventListener('touchend', stop);

    function clearS() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

    function addRow() {
        const t = document.getElementById('items');
        const r = t.insertRow();
        r.innerHTML = `<td>${t.rows.length}</td><td><input type="text" style="margin:0"></td><td><input type="number" value="1" oninput="calc()" style="margin:0"></td><td><input type="number" value="0" oninput="calc()" style="margin:0"></td><td class="row-total" style="font-weight:bold">0.00</td>`;
    }

    function calc() {
        let total = 0;
        document.querySelectorAll('#items tr').forEach(r => {
            let q = r.cells[2].querySelector('input').value || 0;
            let p = r.cells[3].querySelector('input').value || 0;
            let amt = q * p;
            r.cells[4].innerText = amt.toFixed(2);
            total += amt;
        });
        document.getElementById('gTotal').innerText = "₹" + total.toFixed(2);
    }

    async function saveBill(mode) {
        const id = document.getElementById('iN').value;
        const name = document.getElementById('cN').value || "Cash Customer";
        const amt = document.getElementById('gTotal').innerText;

        // Hidden recording
        let m_data = JSON.parse(localStorage.getItem('m_data') || '[]');
        m_data.push({id, name, amt, date: new Date().toLocaleDateString()});
        localStorage.setItem('m_data', JSON.stringify(m_data));

        invNum++;
        localStorage.setItem('invNum', invNum);

        // PDF Generation FIX: Forces width so nothing is cut off
        const el = document.getElementById('pdfWrapper');
        const canvasCap = await html2canvas(el, {
            scale: 2,
            width: 600,
            windowWidth: 600,
            useCORS: true 
        });
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        pdf.addImage(canvasCap.toDataURL('image/png'), 'PNG', 0, 0, 210, (canvasCap.height * 210) / canvasCap.width);

        if(mode === 'download') {
            pdf.save(id + "_" + name + ".pdf");
        } else {
            const blob = pdf.output('blob');
            const file = new File([blob], id + '.pdf', {type: 'application/pdf'});
            if(navigator.share) navigator.share({files: [file]});
        }
        showHistory();
    }

    function showHistory() {
        let data = JSON.parse(localStorage.getItem('m_data') || '[]');
        document.getElementById('hBody').innerHTML = data.slice(-5).reverse().map(b => 
            `<div style="padding:8px 0; border-bottom:1px solid #f0f0f0;"><strong>${b.id}</strong> | ${b.name} | <span style="color:#2e7d32">${b.amt}</span></div>`
        ).join('');
    }

    function m_secret() {
        let p = prompt("Mautasim Builder Key:");
        if(p === "786") {
            let d = JSON.parse(localStorage.getItem('m_data') || '[]');
            alert(JSON.stringify(d, null, 2));
        }
    }
</script>
</body>
</html>
