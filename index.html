<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5189047543441783"
     crossorigin="anonymous"></script>
<title>Shop Billing</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:10px}
#pdfWrapper{
  width: 100%;
  max-width: 794px;   /* desktop & PDF only */
  margin: auto;
  background: white;
  padding: 8px;
}

/* ONLY for PDF / print */
@media print{
  #pdfWrapper{
    width: 794px;
  }
}

.header{text-align:center}
.header img{max-width:120px}
.box{border:1px solid #000;padding:8px;margin-top:8px}
.flex{display:flex;gap:10px;flex-wrap:wrap}
.flex > div{flex:1}
input{width:100%;padding:6px;box-sizing:border-box}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #000;padding:6px;text-align:center}
button{padding:8px;margin-top:10px;width:100%}
canvas{border:1px solid #000;width:100%;height:150px;touch-action:none}
.footer{text-align:center;margin-top:10px;font-size:12px}
@media print{body{background:#fff}}
  @media print {
  button { display: none !important; } /* Hides buttons on the PDF */
  input { border: none !important; }  /* Removes input boxes for a cleaner look */
}

</style>
</head>

<body>

<div id="pdfWrapper">

<div class="header">
  <img src="logo.png" alt="Logo">
  <h2>NAVEED TEXTILES</h2>
</div>

<div class="box">
Email: naveedtextiles14@gmail.com<br>
Phone: 9906403030 / 9906851124
</div>

<!-- Part A: Customer -->
<div class="box flex">
  <div>Customer Name<input id="custName"></div>
  <div>Customer Phone<input id="custPhone"></div>
  <div>customer address<input id="custaddress"></div>
</div>

<div class="box flex">
  <div>Bill No<input id="invoiceNo" readonly></div>
  <div>ðŸ“… Date<input id="billDate" readonly></div>
</div>

<table>
<thead>
<tr><th>#</th><th>Item</th><th>Qty</th><th>Price</th><th>Amount</th></tr>
</thead>
<tbody id="items">
<tr>
<td>1</td>
<td><input></td>
<td><input type="number" oninput="calc()"></td>
<td><input type="number" oninput="calc()"></td>
<td class="amt">0</td>
</tr>
</tbody>
</table>

<button onclick="addRow()">Add Item</button>

<!-- Part B: GST -->
<div class="box flex">
  <div>Discount %<input id="disc" type="number" value="0" oninput="calc()"></div>
  <div>GST %<input id="gst" type="number" value="0" oninput="calc()"></div>
</div>

<div class="box flex">
  <div>Paid â‚¹<input id="paid" type="number" value="0" oninput="calc()"></div>
</div>

<h3 id="total">Total: â‚¹0</h3>
<h3 id="balance">Balance: â‚¹0</h3>

<div class="box">
<h3>Authorized Signature</h3>
<canvas id="sign"></canvas>
<button onclick="clearSign()">Clear Signature</button>
</div>

<div class="footer">Web built by Mautasim</div>
</div>

<button onclick="downloadPDF()">Download PDF</button>
<button onclick="whatsappPDF()">WhatsApp PDF</button>

<script>
// 1. Invoice & Date Logic
let inv = localStorage.getItem('inv') || 1000;
inv++;
localStorage.setItem('inv', inv);
document.getElementById('invoiceNo').value = 'INV-' + inv;
document.getElementById('billDate').value = new Date().toISOString().split('T')[0];

// 2. Add Row Function
function addRow() {
    const t = document.getElementById('items');
    const r = t.insertRow();
    r.innerHTML = `<td>${t.rows.length}</td><td><input></td><td><input type=number oninput=calc()></td><td><input type=number oninput=calc()></td><td class=amt>0</td>`;
}

// 3. Calculation Logic (Fixed to 2 decimal places)
function calc() {
    let sum = 0;
    document.querySelectorAll('#items tr').forEach(r => {
        let q = r.cells[2].querySelector('input').value || 0;
        let p = r.cells[3].querySelector('input').value || 0;
        let a = q * p;
        r.querySelector('.amt').innerText = a.toFixed(2);
        sum += a;
    });
    let d = sum * (document.getElementById('disc').value || 0) / 100;
    let g = (sum - d) * (document.getElementById('gst').value || 0) / 100;
    let total = sum - d + g;
    document.getElementById('total').innerText = `Total: â‚¹${total.toFixed(2)}`;
    document.getElementById('balance').innerText = 'Balance: â‚¹' + (total - (document.getElementById('paid').value || 0)).toFixed(2);
}

// 4. Fixed Signature Logic (Fixes the Desktop "Sign Error")
const canvas = document.getElementById('sign');
const ctx = canvas.getContext('2d');
let draw = false;

function initCanvas() {
    // This part ensures the drawing matches the mouse position exactly
    const rect = canvas.getBoundingClientRect();
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000';
}

// Initialize canvas on load and when window resizes
window.addEventListener('load', initCanvas);
window.addEventListener('resize', initCanvas);

function pos(e) {
    const r = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: clientX - r.left, y: clientY - r.top };
}

const start = (e) => { draw = true; ctx.beginPath(); let p = pos(e); ctx.moveTo(p.x, p.y); };
const move = (e) => { if (!draw) return; e.preventDefault(); let p = pos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
const stop = () => { draw = false; };

canvas.addEventListener('mousedown', start);
canvas.addEventListener('mousemove', move);
window.addEventListener('mouseup', stop);
canvas.addEventListener('touchstart', start, {passive: false});
canvas.addEventListener('touchmove', move, {passive: false});
canvas.addEventListener('touchend', stop);

function clearSign() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

// 5. Improved PDF Generation (Fixes the Mobile "Cutting Off" Error)
async function makePDF() {
    const el = document.getElementById('pdfWrapper');
    
    // TEMPORARY: Force the bill to look like desktop so it captures fully
    const originalWidth = el.style.width;
    el.style.width = '794px'; 

    const c = await html2canvas(el, {
        scale: 2, // High quality
        useCORS: true,
        logging: false,
        windowWidth: 794 // Ensures full width capture
    });

    el.style.width = originalWidth; // Reset back to mobile view

    const img = c.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    
    // Adjust image to fit A4 width (210mm)
    pdf.addImage(img, 'PNG', 0, 0, 210, (c.height * 210) / c.width);
    return pdf;
}

async function downloadPDF() { const pdf = await makePDF(); pdf.save('Invoice.pdf'); }
async function whatsappPDF() { 
    const pdf = await makePDF(); 
    const b = pdf.output('blob'); 
    const f = new File([b], 'Invoice.pdf', { type: 'application/pdf' }); 
    if (navigator.share) { 
        navigator.share({ files: [f], title: 'Invoice' }).catch(err => console.log(err)); 
    } else {
        alert('Sharing is not supported on this browser. Please use Download instead.');
    }
}
  
</script>


</body>
</html>

