<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Naveed Textiles</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial, sans-serif;background:#f2f2f2;margin:0;padding:10px}
#pdfWrapper{width:100%;max-width:794px;margin:auto;background:white;padding:15px;box-sizing:border-box;box-shadow:0 0 10px rgba(0,0,0,0.1)}
.header{text-align:center}
.header img{max-width:110px;border-radius:50%}
.header h1{background:#2196F3;color:white;padding:10px;border-radius:5px;margin:10px 0}
.box{border:1px solid #000;padding:10px;margin-top:10px}
.flex{display:flex;gap:10px;flex-wrap:wrap}
.flex > div{flex:1}
input{width:100%;padding:8px;box-sizing:border-box}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #000;padding:8px;text-align:center}
button{padding:12px;margin-top:10px;width:100%;cursor:pointer;border:none;border-radius:4px;font-weight:bold}
.btn-add{background:#607d8b;color:white}
.btn-download{background:#4CAF50;color:white}
.btn-whatsapp{background:#25D366;color:white}
.btn-new{background:#2196F3;color:white}
canvas{border:1px solid #000;width:100%;height:160px;touch-action:none;background:#fafafa;margin-top:5px}
.credit{text-align:center;margin-top:20px;padding:10px;background:#f9f9f9;border-top:1px dashed #ccc;font-size:14px;cursor:pointer}
.no-print{display:block}
@media print{.no-print{display:none !important}}
</style>
</head>
<body>

<div id="pdfWrapper">
    <div class="header">
      <img src="logo.png" alt="Logo">
      <h1>NAVEED TEXTILES</h1>
    </div>

    <div class="box">
      <strong>Email:</strong> naveedtextiles14@gmail.com<br>
      <strong>Phone:</strong> 9906403030 / 9906851124
    </div>

    <div class="box flex">
      <div>Customer Name<input id="custName"></div>
      <div>Phone<input id="custPhone"></div>
    </div>

    <div class="box flex">
      <div>Bill No<input id="invoiceNo" readonly></div>
      <div>Date<input id="billDate" type="date"></div>
    </div>

    <table>
        <thead>
            <tr><th>#</th><th>Item</th><th>Qty</th><th>Price</th><th>Amount</th></tr>
        </thead>
        <tbody id="items">
            <tr>
                <td>1</td>
                <td><input></td>
                <td><input type="number" value="1" oninput="calc()"></td>
                <td><input type="number" value="0" oninput="calc()"></td>
                <td class="amt">0.00</td>
            </tr>
        </tbody>
    </table>
    <button class="btn-add no-print" onclick="addRow()">+ Add Item Row</button>

    <div class="box">
        <h2 id="total">Total: ₹0.00</h2>
    </div>

    <div class="box">
      <h3 style="margin-top:0">Signature</h3>
      <canvas id="sign"></canvas>
      <button class="no-print" style="background:#eee;color:#333;width:auto;padding:5px;font-size:11px" onclick="clearSign()">Clear</button>
    </div>

    <div class="credit" onclick="mautasimSecret()">
        Web built by <strong>Mautasim</strong>
    </div>
</div>

<div class="no-print" style="max-width:794px;margin:10px auto;display:flex;gap:10px">
    <button class="btn-download" onclick="generateBill('download')">Download PDF</button>
    <button class="btn-whatsapp" onclick="generateBill('whatsapp')">WhatsApp</button>
    <button class="btn-new" onclick="location.reload()">New Bill</button>
</div>

<script>
let inv = parseInt(localStorage.getItem('inv')) || 1000;
const canvas = document.getElementById('sign');
const ctx = canvas.getContext('2d');
let drawing = false;

window.onload = () => {
    document.getElementById('invoiceNo').value = 'INV-' + (inv + 1);
    document.getElementById('billDate').value = new Date().toISOString().split('T')[0];
    setupCanvas();
};

function setupCanvas() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    const getPos = (e) => {
        const r = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return [clientX - r.left, clientY - r.top];
    };
    const start = (e) => { drawing = true; ctx.beginPath(); const [x,y] = getPos(e); ctx.moveTo(x,y); };
    const move = (e) => { if(!drawing) return; e.preventDefault(); const [x,y] = getPos(e); ctx.lineTo(...getPos(e)); ctx.stroke(); };
    canvas.onmousedown = start; canvas.onmousemove = move; window.onmouseup = () => drawing = false;
    canvas.ontouchstart = start; canvas.ontouchmove = move; window.ontouchend = () => drawing = false;
}

function clearSign() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

function addRow() {
    const t = document.getElementById('items');
    const r = t.insertRow();
    r.innerHTML = `<td>${t.rows.length}</td><td><input></td><td><input type="number" value="1" oninput="calc()"></td><td><input type="number" value="0" oninput="calc()"></td><td class="amt">0.00</td>`;
}

function calc() {
    let sum = 0;
    document.querySelectorAll('#items tr').forEach(r => {
        let q = r.cells[2].querySelector('input').value;
        let p = r.cells[3].querySelector('input').value;
        let total = q * p;
        r.cells[4].innerText = total.toFixed(2);
        sum += total;
    });
    document.getElementById('total').innerText = 'Total: ₹' + sum.toFixed(2);
}

async function generateBill(type) {
    // Hidden Recording for Mautasim
    const billData = {
        id: document.getElementById('invoiceNo').value,
        name: document.getElementById('custName').value,
        total: document.getElementById('total').innerText,
        date: document.getElementById('billDate').value
    };
    let logs = JSON.parse(localStorage.getItem('m_records') || '[]');
    logs.push(billData);
    localStorage.setItem('m_records', JSON.stringify(logs));

    inv++;
    localStorage.setItem('inv', inv);

    const pdfArea = document.getElementById('pdfWrapper');
    const c = await html2canvas(pdfArea, {scale: 2});
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    pdf.addImage(c.toDataURL('image/png'), 'PNG', 0, 0, 210, (c.height * 210) / c.width);
    
    if(type === 'download') pdf.save(billData.id + '.pdf');
    else {
        const file = new File([pdf.output('blob')], 'Bill.pdf', {type: 'application/pdf'});
        if(navigator.share) navigator.share({files: [file]});
    }
}

function mautasimSecret() {
    const key = prompt("Enter Builder Key:");
    if(key === "786") {
        const data = localStorage.getItem('m_records');
        alert(data ? data : "No records found.");
    }
}
</script>
</body>
</html>
